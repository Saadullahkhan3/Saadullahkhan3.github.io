name: Minify and Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install Dependencies
      run: |
        npm install -g html-minifier uglify-js csso-cli @node-minify/cli

    - name: Minify Code
      run: |
        html-minifier --input-dir . --output-dir . --file-ext html --collapse-whitespace --remove-comments --minify-js --minify-css
        uglifyjs ./script.js --compress --mangle --output ./script.js 

        perl -pe 's/\/\*.*?\*\///g; s/\s+/ /g; s/^\s+|\s+$//g' ./css/style.css > ./css/style.css
        perl -pe 's/\/\*.*?\*\///g; s/\s+/ /g; s/^\s+|\s+$//g' ./css/infinite_scroll.css > ./css/infinite_scroll.css
        perl -pe 's/\/\*.*?\*\///g; s/\s+/ /g; s/^\s+|\s+$//g' ./css/image_hover.css > ./css/image_hover.css


    - name: Deploy to gh-pages
      uses: JamesIves/github-pages-deploy-action@4.1.0
      with:
        branch: gh-pages
        folder: .
